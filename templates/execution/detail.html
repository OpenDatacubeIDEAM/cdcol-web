{% extends 'base.html' %}

{% block extra_head %}
    <script type="text/javascript">
        {% if execution.state == '1' or execution.state == '2' %}
            function timedRefresh(timeoutPeriod) {
                setTimeout("location.reload(true);", timeoutPeriod);
            }
            window.onload = timedRefresh({{ temporizer_value }});
        {% endif %}
    </script>
{% endblock %}

{% block content %}
    <!-- breadcrumb start -->
    <!-- ================ -->
    <div class="breadcrumb-container">
        <div class="container">
            <ol class="breadcrumb">
                <li><i class="fa fa-home pr-10"></i><a href="/">Inicio</a></li>
                <li><a href="{% url 'execution:index' %}">Ejecuciones</a></li>
                <li class="active">Detalle</li>
            </ol>
        </div>
    </div>
    <!-- breadcrumb end -->

    <!-- main-container start -->
    <!-- ================ -->
    <section class="main-container">

        <div class="container">
            <div class="row">

                <!-- main start -->
                <!-- ================ -->
                <div class="main col-md-8">

                    <!-- page-title start -->
                    <!-- ================ -->
                    <h3 class="page-title">Información de la ejecución</h3>
                    <div class="separator-2"></div>
                    <!-- page-title end -->
                    <p>Esta es la información de la ejecución seleccionada.</p>
                    <table class="table">
                        <tbody>
                        <tr>
                            <td>Código de la ejecución:</td>
                            <td>{{ execution.id }}</td>
                        </tr>
                        <tr>
                            <td>Algoritmo:</td>
                            <td>{{ execution.version.algorithm.name }}</td>
                        </tr>
                        <tr>
                            <td>Versión:</td>
                            <td>{{ execution.version.number }}</td>
                        </tr>
                        <tr>
                            <td>Estado:</td>
                            {% if execution.state == '1' and current_executions.count >= 0 %}
                                <td>{{ execution.get_state_display }} <span class="label label-danger" data-toggle="tooltip" title="Hay {{ current_executions.count }} ejecuciones en espera antes de que esta comience su ejecución" data-placement="right">{{ current_executions.count }}</span></td>
                            {% else %}
                                <td>{{ execution.get_state_display }}</td>
                            {% endif %}
                        </tr>
                        <tr>
                            <td>Fecha de Creación:</td>
                            <td>{{ execution.created_at }}</td>
                        </tr>
                        <tr>
                            <td>Inicio ejecución:</td>
                            <td>{{ execution.started_at }}</td>
                        </tr>
                        <tr>
                            <td>Fin ejecución:</td>
                            <td>{{ execution.finished_at }}</td>
                        </tr>
                        <tr>
                            <td>Creada por:</td>
                            <td>{{ execution.executed_by.email }}</td>
                        </tr>
                        </tbody>
                    </table>

                    <h3 class="page-title">Parámetros de la ejecución</h3>
                    <div class="separator-2"></div>
                    <!-- page-title end -->
                    <p>Los parámetros de la ejecución son los siguientes:</p>
                    <table class="table">
                        <tbody>
                        {% for param in executed_params %}
                            <tr>
                                <td>{{ param.parameter.name }}</td>
                                <td>{{ param.obtain_value }}</td>
                                {% if param.parameter.parameter_type == 12 %}
			                        <td>            
				                        <a href="{% url 'execution:download_parameter_file' execution.id param.parameter.name param.filetype.file_name %}" class="btn btn-gray btn-sm"><i class="fa fa-bars"></i> Descargar</a>
			                        </td>
                        	 	{% endif %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                    {% if execution.results_deleted_at %}
                        <h3 class="page-title">Resultados generados</h3>
                        <div class="separator-2"></div>
                        <p><span class="label label-danger">Los archivos fueron eliminados el {{ execution.results_deleted_at }}</span></p>
                    {% else %}
                        {% if files %}
                            <h3 class="page-title">Resultados generados</h3>
                            <div class="separator-2"></div>
                            <p>A continuación se encuentran los archivos generados por esta ejecución:</p>

                            {% if delete_time %}
                                <p><span class="label label-warning">Estos archivos serán borrados el {{ delete_time }}</span></p>
                            {% endif %}
                            {% if response_message %}
                                <p><span class="label label-danger">{{ response_message }}</span></p>
                            {% endif %}
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-colored">
                                            <thead>
                                            <tr>
                                                <th>Nombre</th>
                                                <th>Acciones</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            {% for file in files %}
                                                <tr>
                                                    {% if ".gif" in file %}
                                                        <td><img src="{{ system_path }}{{ file }}"></td>
                                                        <td>
                                                            <a href="{% url 'execution:download_result' execution.id file %}" class="btn btn-gray btn-sm"><i class="fa fa-bars"></i> Descargar</a>
                                                        </td>
                                                    {% else %}
                                                        <td>{{ file }}</td>
                                                        <td>
                                                            <a href="{% url 'execution:download_result' execution.id file %}" class="btn btn-gray btn-sm"><i class="fa fa-bars"></i> Descargar</a>
                                                            {% if not execution.version.algorithm.multitemporal %}
                                                                <a href="{% url 'execution:generate_geotiff' execution.id file %}" class="btn btn-gray btn-sm"><i class="fa fa-file-image-o"></i> Descargar Geotiff</a>
                                                            {% endif %}
                                                        </td>
                                                    {% endif %}
                                                    

                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}


                    <h3 class="page-title">Traza de errores</h3>
                    <div class="separator-2"></div>
                    <p>La traza del error de la ejecución es la siguiente::</p>

                    <pre><code style="color: #c7254e;">{{ execution.trace_error }}</code></pre>
                </div>
                <!-- main end -->

                <!-- sidebar start -->
                <!-- ================ -->
                <aside class="col-md-4 col-lg-3 col-lg-offset-1">
                    <div class="sidebar">
                        <div class=" clearfix">
                            <h3 class="title">Acciones</h3>
                            <div class="separator-2"></div>
                            {% if review %}
                                <nav>
                                    <a href="#" class="btn btn-gray btn-md btn-block">No hay acciones disponibles</a>
                                </nav>
                            {% else %}
                                <nav>
                                    {% if user.is_authenticated %}
                                        {% if perms.execution.can_rate_execution %}
                                            <a href="{% url 'execution:rate_execution' execution.id %}#rating" class="btn btn-primary btn-md btn-block">Calificar Resultados de la
                                                Ejecución</a>
                                        {% else %}
                                            <a href="#" class="btn btn-gray btn-md btn-block">No hay acciones disponibles</a>
                                        {% endif %}
                                    {% endif %}
                                </nav>
                            {% endif %}

                        </div>
                        {% if review %}
                            <div class="block clearfix">
                                <h3 class="title">Calificación realizada</h3>
                                <div class="separator-2"></div>
                                <p>La calificación que realizaste de los resultados de esta ejecución es la
                                    siguiente:</p>
                                <nav>
                                    <ul>
                                        <li>Calificación: {{ review.rating }}</li>
                                        <li>Comentario: {{ review.comments }}</li>
                                    </ul>
                                </nav>
                            </div>
                        {% endif %}
                    </div>
                </aside>
                <!-- sidebar end -->

            </div>
        </div>
    </section>
    <!-- main-container end -->
{% endblock %}